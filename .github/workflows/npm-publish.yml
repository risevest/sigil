name: Npm Publish

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: ğŸ“¦ Install packages and prebuild
        run: bun install --frozen-lockfile
        shell: bash
      - name: ğŸ”„ Sync versions
        run: echo "Skipping sync versions step in publish workflow"
      - name: ğŸš€ Publish Sigil
        run: |
          PACKAGE_VERSION=$(cat ./package.json | jq -r .version)
          cd packages/sigil
          ls 
       
          echo "Publishing Sigil version $PACKAGE_VERSION"
          npm version $PACKAGE_VERSION --no-git-tag-version
          cat package.json
          bun publish --access public --verbose
        env:
          CI: true
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
      - name: ğŸš€ Publish Sicily
        run: cd packages/sicily && bun publish --access public
        env:
          CI: true
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
