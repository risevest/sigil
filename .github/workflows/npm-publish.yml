name: Npm Publish

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸž Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: ðŸ“¦ Install packages and prebuild
        run: cd packages/sigil && bun install --frozen-lockfile
        shell: bash
      - name: ðŸ”„ Sync versions
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
      - name: ðŸš€ Publish Sigil
        run: |
          cat ~/.npmrc
          PACKAGE_VERSION=$(cat ./package.json | jq -r .version)
          cd packages/sigil
          ls 
       
          echo "Publishing Sigil version $PACKAGE_VERSION"
          npm version $PACKAGE_VERSION --no-git-tag-version
          cat package.json
          npm publish --access public 
        env:
          CI: true
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
      - name: ðŸš€ Publish Sicily
        run: cd packages/sicily && bun publish --access public
        env:
          CI: true
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
